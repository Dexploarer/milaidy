# Nixpacks build configuration for Sevalla (formerly Kinsta) deployment
# Nixpacks auto-detects Bun from bun.lock in the repo root.

# Disable SPA/Caddy auto-detection â€” this is a full Node.js server, not a static site.
[variables]
NIXPACKS_SPA_CADDY    = "false"
NODE_ENV              = "production"
NPM_CONFIG_PRODUCTION = "false"

# Pin Node 22 alongside Bun (Bun is auto-provided by the Node provider).
[phases.setup]
nixPkgs = ["...", "nodejs_22"]

# Bun install (auto-detected from bun.lock, but explicit for clarity).
[phases.install]
cmds = ["bun install --frozen-lockfile"]

# Full build: compile agent runtime (tsdown) + web UI (Vite).
[phases.build]
cmds = ["bun run build"]

# Start the agent server. Sevalla injects PORT at runtime.
[start]
cmd = "MILADY_PORT=${PORT:-2138} MILADY_API_BIND=0.0.0.0 node milady.mjs start"
