# Nixpacks build configuration for Sevalla deployment
# Installs Bun explicitly since there's no bun.lock for auto-detection.

[variables]
NIXPACKS_SPA_CADDY    = "false"
NODE_ENV              = "production"
NPM_CONFIG_PRODUCTION = "false"

# Pin Node 22 + system libs needed by native modules
[phases.setup]
nixPkgs = ["...", "nodejs_22"]

# Install Bun first, then use it for dependency installation.
# Chained in one command so PATH is available to bun install.
# postinstall hooks also need bun, so it must be installed first.
[phases.install]
cmds = ["curl -fsSL https://bun.sh/install | bash && export PATH=/root/.bun/bin:$PATH && bun install"]

# Full build: compile agent runtime (tsdown) + web UI (Vite)
[phases.build]
cmds = ["export PATH=/root/.bun/bin:$PATH && bun run build"]

# Start the agent server. Sevalla injects PORT at runtime.
[start]
cmd = "MILADY_PORT=${PORT:-2138} MILADY_API_BIND=0.0.0.0 node milady.mjs start"
