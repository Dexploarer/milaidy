# Nixpacks build configuration for Sevalla deployment
# Bun added via Nix packages (not curl) for reliable PATH availability.

[variables]
NIXPACKS_SPA_CADDY    = "false"
NODE_ENV              = "production"
NPM_CONFIG_PRODUCTION = "false"

# Pin Node 22 + Bun via Nix packages. "..." preserves auto-detected packages.
[phases.setup]
nixPkgs = ["...", "nodejs_22", "bun"]

# Install dependencies with Bun (available via Nix).
# postinstall hooks also call bun, so Bun must be on PATH before this runs.
[phases.install]
cmds = ["bun install"]

# Full build: compile agent runtime (tsdown) + web UI (Vite)
[phases.build]
cmds = ["bun run build"]

# Start the agent server. Sevalla injects PORT at runtime.
[start]
cmd = "MILADY_PORT=${PORT:-2138} MILADY_API_BIND=0.0.0.0 node milady.mjs start"
